<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
        http://www.liquibase.org/xml/ns/pro
        http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd">

    <!-- This change set inserts distinct flight statuses from historical_flight_raw into flight_status table -->
    <changeSet id="put-data-to-status" author="yuzdzhan.ahmed">
        <sql>
            INSERT INTO flight_status (status)
            SELECT DISTINCT flight_status
            FROM historical_flight_raw
            WHERE flight_status IS NOT NULL
            AND flight_status NOT IN (SELECT status FROM flight_status);
        </sql>
    </changeSet>

    <!-- This change set migrates unique city_name and timezone combinations from cities_raw to city table -->
    <changeSet id="migrate-data-to-city" author="yuzdzhan.ahmed">
        <sql>
            INSERT INTO city (city_name, timezone, iata_code)
            SELECT city_name, timezone, iata_code
            FROM [dbo].[cities_raw]
            WHERE city_name IS NOT NULL
            GROUP BY city_name, timezone, iata_code
            HAVING COUNT(*) = 1;
        </sql>
    </changeSet>

    <changeSet id="migrate-data-to-airport" author="yuzdzhan.ahmed">
        <sql>
            INSERT INTO airport (airport_name, iata_code, city_id)
            SELECT DISTINCT ar.airport_name, ar.iata_code, c.id
            FROM airport_raw ar
            JOIN city c ON ar.city_iata_code = c.iata_code
            LEFT JOIN airport a ON ar.airport_name = a.airport_name AND ar.iata_code = a.iata_code
            WHERE ar.airport_name IS NOT NULL
            AND ar.iata_code IS NOT NULL
            AND c.id IS NOT NULL
            AND a.id IS NULL;
        </sql>
    </changeSet>

    <changeSet id="migrate-data-to-airline" author="yuzdzhan.ahmed">
        <sql>
            INSERT INTO airline (airline_name, icao_code, iata_code)
            SELECT DISTINCT airline_name, icao_code, iata_code
            FROM airline_raw
            WHERE airline_name IS NOT NULL
            AND airline_name NOT IN ('Blocked');
        </sql>
    </changeSet>

    <changeSet id="migrate-data-to-aircraft" author="yuzdzhan.ahmed">
        <sql>
            INSERT INTO aircraft (aircraft_model, aircraft_reg, aita_assignment, aircraft_age)
            SELECT production_line, registration_number, iata_code_short, plane_age
            FROM airplane_raw
            WHERE registration_number IS NOT NULL;
        </sql>
    </changeSet>

    <changeSet id="update-NULL-flight-status-to-unknown" author="yuzdzhan.ahmed">
        <sql>
            UPDATE historical_flight_raw
            SET flight_status = 'UNKNOWN'
            WHERE flight_status IS NULL;
        </sql>
    </changeSet>

    <changeSet id="update-departure-actual-with-scheduled" author="yuzdzhan.ahmed">
        <sql>
            UPDATE historical_flight_raw
            SET departure_actual = departure_scheduled
            WHERE departure_actual IS NULL
            AND departure_scheduled IS NOT NULL;
        </sql>
    </changeSet>

    <changeSet id="update-arrival-actual-with-scheduled" author="yuzdzhan.ahmed">
        <sql>
            UPDATE historical_flight_raw
            SET arrival_actual = arrival_scheduled
            WHERE arrival_actual IS NULL
            AND arrival_scheduled IS NOT NULL;
        </sql>
    </changeSet>

    <changeSet id="migrate-to-flight-with-status-LANDED" author="yuzdzhan.ahmed">
        <sql>
            INSERT INTO flight (
            flight_date,
            departure_time,
            arrival_time,
            range,
            departure_iata_code,
            arrival_iata_code,
            airline_iata,
            airline_icao,
            flight_status_id,
            departure_airport_id,
            arrival_airport_id,
            aircraft_id,
            airline_id
            )
            SELECT
            hfr.flight_date,
            hfr.departure_actual AS departure_time,
            hfr.arrival_actual AS arrival_time,
            hfr.range_post_processing AS range,
            hfr.departure_iata AS departure_iata_code,
            hfr.arrival_iata AS arrival_iata_code,
            hfr.airline_iata AS airline_iata,
            hfr.airline_icao AS airline_icao,
            (SELECT id FROM flight_status WHERE status = 'LANDED') AS flight_status_id,
            NULL AS departure_airport_id,
            NULL AS arrival_airport_id,
            a.id AS aircraft_id,
            NULL AS airline_id
            FROM dbo.historical_flight_raw hfr
            LEFT JOIN aircraft a ON hfr.aircraft_registration = a.aircraft_reg
            WHERE hfr.flight_status = 'LANDED';
        </sql>
    </changeSet>

    <changeSet id="update-departure-airport-id" author="yuzdzhan.ahmed">
        <sql>
            UPDATE flight
            SET departure_airport_id = airport.id
            FROM flight
            JOIN airport ON flight.departure_iata_code = airport.iata_code
            WHERE flight.departure_airport_id IS NULL;
        </sql>
    </changeSet>

    <changeSet id="update-arrival-airport-id" author="yuzdzhan.ahmed">
        <sql>
            UPDATE flight
            SET arrival_airport_id = airport.id
            FROM flight
            JOIN airport ON flight.arrival_iata_code = airport.iata_code
            WHERE flight.arrival_airport_id IS NULL;
        </sql>
    </changeSet>
    <changeSet id="update-airline-id" author="yuzdzhan.ahmed">
        <sql>
            UPDATE flight
            SET airline_id = airline.id
            FROM flight
            JOIN airline ON flight.airline_iata = airline.iata_code OR flight.airline_icao = airline.icao_code
            WHERE flight.airline_id IS NULL;
        </sql>
    </changeSet>
    <changeSet id="update-airline-id" author="yuzdzhan.ahmed">
        <sql>
            UPDATE flight
            SET airline_id = airline.id
            FROM flight
            JOIN airline ON flight.airline_iata = airline.iata_code OR flight.airline_icao = airline.icao_code
            WHERE flight.airline_id IS NULL;
        </sql>
    </changeSet>

    <changeSet id="hard-release-lock" author="yuzdzhan.ahmed">
        <sql>
            DELETE FROM DATABASECHANGELOGLOCK WHERE ID=1;
        </sql>
    </changeSet>

<!--    <changeSet id="update-departure-actual" author="yuzdzhan.ahmed">-->
<!--        <sql>-->
<!--            UPDATE historical_flight_raw-->
<!--            SET departure_actual = departure_estimated-->
<!--            WHERE departure_actual IS NULL-->
<!--            AND departure_estimated IS NOT NULL-->
<!--            AND flight_status IN ('DIVERTED', 'LANDED', 'ACTIVE');-->
<!--        </sql>-->
<!--    </changeSet>-->

<!--    <changeSet id="update-arrival-actual" author="yuzdzhan.ahmed">-->
<!--        <sql>-->
<!--            UPDATE historical_flight_raw-->
<!--            SET arrival_actual = arrival_estimated-->
<!--            WHERE arrival_actual IS NULL-->
<!--            AND arrival_estimated IS NOT NULL-->
<!--            AND flight_status IN ('LANDED');-->
<!--        </sql>-->
<!--    </changeSet>-->


</databaseChangeLog>